Когда подписчики регистрируются для получения сообщений от издателя, паттерн 1:N (один ко многим) гарантирует, что любое сообщение, отправленное издателем, достигнет всех зарегистрированных подписчиков. NATS предоставляет дополнительную функцию под названием "очередь", которая позволяет подписчикам регистрироваться как часть очереди. Подписчики, входящие в очередь, образуют "группу очереди".
### Как функционируют группы очередей
В качестве примера рассмотрим доставку сообщений, происходящую по паттерну 1:N для всех подписчиков на основе имени темы (доставка происходит даже к подписчикам, которые не входят в группу очереди). Если подписчик зарегистрирован на основе имени очереди, он всегда будет получать сообщения, на которые подписан, в зависимости от имени темы. Однако, если к тому же имени очереди добавляются дополнительные подписчики, они образуют группу очереди, и только один случайно выбранный подписчик из этой группы будет обрабатывать сообщение каждый раз, когда сообщение поступает в группу очереди. Такие распределённые очереди являются встроенной функцией балансировки нагрузки, которую предоставляет NATS.

### Преимущества

- Обеспечивает отказоустойчивость приложения.
- Обработку нагрузки можно масштабировать вверх или вниз.
- Масштабируйте своих потребителей вверх или вниз без дублирования сообщений.
- Не требуется дополнительная конфигурация.
- Группы очередей определяются приложением и его подписчиками очереди, а не конфигурацией сервера.

Названия групп очередей следуют тем же правилам именования, что и темы. Прежде всего, они чувствительны к регистру и не могут содержать пробелы. Рекомендуется структурировать группы очередей иерархически, используя точку (.). Некоторые функции сервера могут использовать подстановочное соответствие для них.

Подписчики очередей идеально подходят для масштабирования сервисов. Масштабирование вверх осуществляется так же просто, как запуск другого приложения, а масштабирование вниз — завершением приложения с сигналом, который обрабатывает текущие запросы. Эта гибкость и отсутствие необходимости в изменениях конфигурации делают NATS отличной технологией для коммуникации между сервисами, которая может работать с любыми платформенными технологиями.

### Нет ответчика

Когда запрос отправляется на сервис (паттерн запрос-ответ), и сервер NATS знает, что доступных сервисов нет (поскольку в данный момент нет клиентских приложений, подписанных на тему в группе очереди), сервер отправит обратно клиенту, сделавшему запрос, сообщение протокола "нет ответчиков" (no-responders). Это прерывает блокирующие вызовы API. Такой подход позволяет приложениям реагировать немедленно. Это также способствует созданию высоко отзывчивой системы в масштабах, даже в условиях сбоев приложений и сетевых разделений.

### Поток как очередь

С помощью JetStream поток также может использоваться в качестве очереди, установив политику хранения в WorkQueuePolicy и используя потребителей с вытягиванием (pull consumers) для обеспечения простой горизонтальной масштабируемости обработки (или используя явного потребителя с подтверждением (ack) и группу подписчиков).

![[Pasted image 20240827012624.png]]

